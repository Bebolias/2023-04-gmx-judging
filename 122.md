Ch_301

false

# [Dup] [05-30 243]  If a sequencer becomes unavailable, Protocol will use a stale price

## Summary
Keeper will pass `OracleUtils.SetPricesParams` (struct used in setPrices) to [Oracle.setPrices()](https://github.com/sherlock-audit/2023-04-gmx/blob/main/gmx-synthetics/contracts/oracle/Oracle.sol#L197-L245).
It sub-call [Oracle._setPricesFromPriceFeeds()](https://github.com/sherlock-audit/2023-04-gmx/blob/main/gmx-synthetics/contracts/oracle/Oracle.sol#L625-L661) to set prices using external price feeds in order to save some gas costs for tokens with stable prices.
To do that Keeper shouldn't pass the signed prices for the stable prices
```solidity
            if (!primaryPrices[token].isEmpty()) {
                revert Errors.PriceAlreadySet(token, primaryPrices[token].min, primaryPrices[token].max);
            }
```

## Vulnerability Detail
[Oracle._getPriceFeedPrice()](https://github.com/sherlock-audit/2023-04-gmx/blob/main/gmx-synthetics/contracts/oracle/Oracle.sol#L588-L619) will check if the token has a `priceFeedAddress` otherwise tx will revert.
[If a sequencer becomes unavailable](https://docs.chain.link/data-feeds/l2-sequencer-feeds), GMX v2 could receive stale price from oracle 
1- in case the token has a `stablePrice` and  `price < stablePrice` 

```solidity
            if (stablePrice > 0) {
                priceProps = Price.Props(
                    price < stablePrice ? price : stablePrice,//min
                    price < stablePrice ? stablePrice : price //max
                );
            }
```
 It will set stale price as a min price (which will be used as the main price for users in all the calculations)

2 - in case the token has no `stablePrice` means `stablePrice = 0 ` 
```solidity
            } else {
                priceProps = Price.Props(
                    price,
                    price
                );
            }
```
It will set stale prices as a min and max price. which will cause users/protocol to lose funds depending on the price. 

## Impact
- The protocol will use a stale price and this effect users/protocol by losing funds
- This rule is being violated ` if the X action was created at block n, it should be executed with the oracle prices at block n.`
## Code Snippet

## Tool used

Manual Review

## Recommendation
Check the sequencer status and return the latest data
```solidity
        (
            /*uint80 roundID*/,
            int256 answer,
            uint256 startedAt,
            /*uint256 updatedAt*/,
            /*uint80 answeredInRound*/
        ) = sequencerUptimeFeed.latestRoundData();

        // Answer == 0: Sequencer is up
        // Answer == 1: Sequencer is down
        bool isSequencerUp = answer == 0;
        if (!isSequencerUp) {
            revert SequencerDown();
        }

        // Make sure the grace period has passed after the
        // sequencer is back up.
        uint256 timeSinceUp = block.timestamp - startedAt;
        if (timeSinceUp <= GRACE_PERIOD_TIME) {
            revert GracePeriodNotOver();
        }
```